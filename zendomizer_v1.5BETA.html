<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ZENDOMIZER 1.2</title>
  <style>
    body {
      font-family: 'Orbitron', sans-serif;
      background: #000;
      color: #fff;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .machine-wrapper {
      background: url('ZENDOMIZER_pic.jpeg') no-repeat center top;
      background-size: contain;
      width: 100%;
      max-width: 960px;
      padding-top: 700px;
      position: relative;
    }

    .control-panel {
      background: rgba(0, 0, 0, 0.7);
      padding: 20px;
      border-radius: 12px;
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .filter-row, .category-grid, .button-row {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 12px;
    }

    select, button {
      padding: 10px 14px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      font-size: 16px;
    }

    #bikeFilterBtn {
      width: 140px;
      text-align: left;
    }

    .category-grid {
      margin-top: 10px;
    }

    .catLabel {
      background-color: #222;
      color: #fff;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
    }

    .results-panel {
      margin-top: 20px;
      width: 100%;
      max-width: 960px;
    }

    .vehicle {
      background: #111;
      border: 1px solid #444;
      border-radius: 8px;
      padding: 10px 14px;
      margin-bottom: 10px;
    }

    .start-btn {
      background: orange;
      color: black;
      font-weight: bold;
      font-size: 18px;
    }

    .copy-btn {
      background: cyan;
      color: black;
      font-weight: bold;
      font-size: 18px;
    }

    #copyNotice {
      color: lime;
      margin-top: 10px;
      display: none;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="machine-wrapper">
    <div class="control-panel">
      <div class="filter-row">
        <button id="bikeFilterBtn" onclick="toggleBikeFilter()">Nur Autos</button>
        <select id="countrySelect" onchange="updatePreview()">
          <option value="">Land wählen</option>
        </select>
        <select id="brandSelect" onchange="updatePreview()">
          <option value="">Marke wählen</option>
        </select>
        <select id="eraSelect" onchange="updatePreview()">
          <option value="">Zeitraum wählen</option>
        </select>
      </div>

      <div class="category-grid">
        <label class="catLabel" style="background:#0097A7; padding:10px; border-radius:8px; color:white;">
          <input class="catCheckbox" onchange="handleCategoryClick(this)" type="checkbox" value="Street Tier 1"/> Street Tier 1
            </label>
          <label class="catLabel" style="background:#0097A7; padding:10px; border-radius:8px; color:white;">
          <input class="catCheckbox" onchange="handleCategoryClick(this)" type="checkbox" value="Street Tier 2"/> Street Tier 2
            </label>
          <label class="catLabel" style="background:#388E3C; padding:10px; border-radius:8px; color:white;">
          <input class="catCheckbox" onchange="handleCategoryClick(this)" type="checkbox" value="Rally"/> Rally
            </label>
          <label class="catLabel" style="background:#388E3C; padding:10px; border-radius:8px; color:white;">
          <input class="catCheckbox" onchange="handleCategoryClick(this)" type="checkbox" value="Rally Raid"/> Rally Raid
            </label>
          <label class="catLabel" style="background:#388E3C; padding:10px; border-radius:8px; color:white;">
          <input class="catCheckbox" onchange="handleCategoryClick(this)" type="checkbox" value="Motocross"/> Motocross
            </label>
          <label class="catLabel" style="background:#D32F2F; padding:10px; border-radius:8px; color:white;">
          <input class="catCheckbox" onchange="handleCategoryClick(this)" type="checkbox" value="Racing"/> Racing
            </label>
          <label class="catLabel" style="background:#D32F2F; padding:10px; border-radius:8px; color:white;">
          <input class="catCheckbox" onchange="handleCategoryClick(this)" type="checkbox" value="AGP"/> AGP
            </label>
          <label class="catLabel" style="background:#D32F2F; padding:10px; border-radius:8px; color:white;">
          <input class="catCheckbox" onchange="handleCategoryClick(this)" type="checkbox" value="Hypercar"/> Hypercar
            </label>
          <label class="catLabel" style="background:#D32F2F; padding:10px; border-radius:8px; color:white;">
          <input class="catCheckbox" onchange="handleCategoryClick(this)" type="checkbox" value="Monster Truck"/> Monster Truck
            </label>
      </div>

      <div class="button-row">
        <button class="start-btn" onclick="drawRandomVehicles()">START</button>
        <button class="copy-btn" onclick="copyToClipboard()">📋 Auswahl kopieren</button>
      </div>

      <div id="copyNotice">✅ In Zwischenablage kopiert!</div>
    </div>

    <div class="results-panel" id="results">
      <!-- Fahrzeuge erscheinen hier -->
    </div>
  </div>

  <script src="https://shogun160.github.io/TCM-ZEN_DOMIZER/cars/vehicles.json" type="application/json"></script>
  <script>
    let selectedOrder = [];

    function handleCategoryClick(checkbox) {
      const value = checkbox.value;
      if (checkbox.checked) {
        if (!selectedOrder.includes(value)) {
          selectedOrder.push(value);
        }
      } else {
        selectedOrder = selectedOrder.filter(v => v !== value);
      }
      updateCheckboxBadges();
      updatePreview();
    }

    function updateCheckboxBadges() {
      const allCheckboxes = document.querySelectorAll('.catCheckbox');
      allCheckboxes.forEach(cb => {
        const label = cb.closest("label");
        let badge = label.querySelector('.order-badge');
        const index = selectedOrder.indexOf(cb.value);
        if (index !== -1) {
          if (!badge) {
            badge = document.createElement("span");
            badge.className = "order-badge";
            label.insertBefore(badge, cb.nextSibling);
          }
          badge.innerText = (index + 1).toString();
        } else if (badge) {
          badge.remove();
        }
      });
    }

    let bikeFilterMode = "no_bike";

    function initializeDropdowns() {
    const brandSelect = document.getElementById("brandSelect");
    const countrySelect = document.getElementById("countrySelect");
    const eraSelect = document.getElementById("eraSelect");

    // Marken ergänzen (lassen Platzhalter bestehen)
    const brandSet = new Set(vehicles.map(v => v.brand));
    [...brandSet].sort().forEach(brand => {
      const option = document.createElement("option");
      option.value = brand;
      option.textContent = brand;
      brandSelect.appendChild(option);
    });

    // Länder ergänzen (lassen Platzhalter + "Alle Länder" bestehen)
    const countrySet = new Set(vehicles.map(v => v.country));
    [...countrySet].sort().forEach(country => {
      const option = document.createElement("option");
      option.value = country;
      option.textContent = country;
      countrySelect.appendChild(option);
    });

    // Zeiträume ergänzen
    const eraSet = new Set(vehicles.map(v => v.era));
    [...eraSet].sort().forEach(era => {
      const option = document.createElement("option");
      option.value = era;
      option.textContent = era;
      eraSelect.appendChild(option);
    });
    }


    function getCurrentFilters() {
      return {
        brand: document.getElementById("brandSelect").value,
        country: document.getElementById("countrySelect").value,
        era: document.getElementById("eraSelect").value
      };
    }



    let lastSelection = [];

    function toggleBikeFilter() {
      if (bikeFilterMode === 'no_bike') {
        bikeFilterMode = 'bike';
        document.getElementById("bikeFilterBtn").innerText = "Nur Bikes";
      } else if (bikeFilterMode === 'bike') {
        bikeFilterMode = 'all';
        document.getElementById("bikeFilterBtn").innerText = "Alle Fahrzeuge";
      } else {
        bikeFilterMode = 'no_bike';
        document.getElementById("bikeFilterBtn").innerText = "Nur Autos";
      }
    }

    function updateBrandDropdown() {
      const brandSet = new Set(vehicles.map(v => v.brand));
      const dropdown = document.getElementById("brandSelect");
      [...brandSet].sort().forEach(brand => {
        const opt = document.createElement("option");
        opt.value = brand;
        opt.innerText = brand;
        dropdown.appendChild(opt);
      });
    }

    function updatePreview() {
      const filters = getCurrentFilters();
      const selectedCategories = Array.from(document.querySelectorAll('.catCheckbox'))
        .filter(cb => cb.checked)
        .map(cb => cb.value);
      const filterText = bikeFilterMode === 'bike' ? "Nur Bikes"
                      : bikeFilterMode === 'no_bike' ? "Nur Autos"
                      : "Alle Fahrzeuge";
      const brand = document.getElementById("brandSelect").value;
      const brandText = brand ? `Marke: ${brand}` : "Alle Marken";
      const country = filters.country;
      const era = filters.era;
      const extra = (country ? ` | Land: ${country}` : "") + (era ? ` | Zeitraum: ${era}` : "");

      document.getElementById("preview").innerText =
        "Auswahl: " + (selectedCategories.join(", ") || "–") + " | Filter: " + filterText + " | " + brandText + extra;
        "Auswahl: " + (selectedCategories.join(", ") || "–") + " | Filter: " + filterText + " | " + brandText;
    }


    function drawRandomVehicles() {
      const filters = getCurrentFilters();
      const selectedCategories = Array.from(document.querySelectorAll('.catCheckbox'))
        .filter(cb => cb.checked)
        .map(cb => cb.value);

      const selectedBrand = filters.brand;

      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '';
      document.getElementById('copiedMsg').innerText = '';

      if (selectedCategories.length < 3) {
        resultsDiv.innerHTML = "<p>⚠️ Bitte 3 Kategorien auswählen.</p>";
        return;
      }

      const shuffledCategories = selectedCategories.sort(() => 0.5 - Math.random()).slice(0, 3);
      const chosen = [];

      for (let cat of shuffledCategories) {
        
        let ignored = [];

        let finalList = [];

        // Schritt 1: Alle aktiven Filter
        finalList = vehicles.filter(v =>
          v.category === cat &&
          (bikeFilterMode === 'all' || (bikeFilterMode === 'no_bike' && v.bike === false) || (bikeFilterMode === 'bike' && v.bike === true)) &&
          (!filters.country || v.country === filters.country) &&
          (!filters.era || v.era === filters.era) &&
          (!filters.brand || v.brand === filters.brand)
        );

        if (finalList.length === 0) {
          // Schritt 2: Bike-Filter ignorieren (nur wenn aktiv)
          if (bikeFilterMode === 'no_bike' || bikeFilterMode === 'bike') {
            const fallback = vehicles.filter(v =>
              v.category === cat &&
              (!filters.country || v.country === filters.country) &&
              (!filters.era || v.era === filters.era) &&
              (!filters.brand || v.brand === filters.brand)
            );
            if (fallback.length > 0) {
              finalList = fallback;
              ignored.push(bikeFilterMode === 'no_bike' ? 'Nur Autos' : 'Nur Bikes');
            }
          }
        }

        // Schritt 3–5: Einzelne Filter ignorieren (nur wenn aktiv)
        if (finalList.length === 0 && filters.era) {
          const fallback = vehicles.filter(v =>
            v.category === cat &&
            (bikeFilterMode === 'all' || (bikeFilterMode === 'no_bike' && v.bike === false) || (bikeFilterMode === 'bike' && v.bike === true)) &&
            (!filters.country || v.country === filters.country) &&
            (!filters.brand || v.brand === filters.brand)
          );
          if (fallback.length > 0) {
            finalList = fallback;
            ignored.push(`Zeitraum (${filters.era})`);
          }
        }

        if (finalList.length === 0 && filters.brand) {
          const fallback = vehicles.filter(v =>
            v.category === cat &&
            (bikeFilterMode === 'all' || (bikeFilterMode === 'no_bike' && v.bike === false) || (bikeFilterMode === 'bike' && v.bike === true)) &&
            (!filters.country || v.country === filters.country) &&
            (!filters.era || v.era === filters.era)
          );
          if (fallback.length > 0) {
            finalList = fallback;
            ignored.push(`Marke (${filters.brand})`);
          }
        }

        if (finalList.length === 0 && filters.country) {
          const fallback = vehicles.filter(v =>
            v.category === cat &&
            (bikeFilterMode === 'all' || (bikeFilterMode === 'no_bike' && v.bike === false) || (bikeFilterMode === 'bike' && v.bike === true)) &&
            (!filters.era || v.era === filters.era) &&
            (!filters.brand || v.brand === filters.brand)
          );
          if (fallback.length > 0) {
            finalList = fallback;
            ignored.push(`Land (${filters.country})`);
          }
        }

        // Schritt 6: Alle außer Kategorie & Bike-Filter ignorieren
        if (finalList.length === 0) {
          const fallback = vehicles.filter(v =>
            v.category === cat &&
            (bikeFilterMode === 'all' || (bikeFilterMode === 'no_bike' && v.bike === false) || (bikeFilterMode === 'bike' && v.bike === true))
          );
          if (fallback.length > 0) {
            finalList = fallback;
            if (filters.era) ignored.push(`Zeitraum (${filters.era})`);
            if (filters.brand) ignored.push(`Marke (${filters.brand})`);
            if (filters.country) ignored.push(`Land (${filters.country})`);
          }
        }

        // Schritt 7: Alles ignorieren außer Kategorie
        if (finalList.length === 0) {
          const fallback = vehicles.filter(v => v.category === cat);
          if (fallback.length > 0) {
            finalList = fallback;
            ignored.push('Alle');
          }
        }

        if (finalList.length === 0) continue;

        const vehicle = finalList[Math.floor(Math.random() * finalList.length)];
        chosen.push({...vehicle, ignoredFilters: ignored});
      }

      if (chosen.length !== 3) {
        resultsDiv.innerHTML = "<p>⚠️ Nicht genügend Fahrzeuge gefunden.</p>";
        return;
      }

      chosen.sort((a, b) => selectedOrder.indexOf(a.category) - selectedOrder.indexOf(b.category));

      lastSelection = chosen;

      chosen.forEach(v => {
        const el = document.createElement('div');
        const hasIgnored = v.ignoredFilters.length > 0;
        el.className = 'vehicle' + (hasIgnored ? ' filter-ignored' : '');
        el.title = hasIgnored ? 'Filter ignoriert: ' + v.ignoredFilters.join(', ') : '';
        el.innerHTML = `<strong>${v.category}</strong><br>${v.brand} ${v.model} (${v.year})${v.ignoredFilters?.length > 0 ? ' <span style="color: orange;">⚠️</span> <span style="color: gray; font-size: 90%;">' + v.ignoredFilters.join(', ') + '</span>' : ''}`;
        resultsDiv.appendChild(el);
      });

      resultsDiv.scrollIntoView({ behavior: 'smooth' });
      copyToClipboard();
    }


    function repeatDraw() {
      if (!lastSelection || lastSelection.length === 0) {
        drawRandomVehicles();
        return;
      }

      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '';
      document.getElementById('copiedMsg').innerText = '';

      lastSelection.forEach(v => {
        const el = document.createElement('div');
        el.className = 'vehicle' + (v.brandIgnored ? ' filter-ignored' : '');
        el.title = v.brandIgnored ? 'Markenfilter ignoriert – kein passendes Fahrzeug in dieser Kategorie.' : '';
        el.innerHTML = `<strong>${v.category}</strong><br>${v.brand} ${v.model} (${v.year})${v.ignoredFilters?.length > 0 ? ' <span style="color: orange;">⚠️</span> <span style="color: gray; font-size: 90%;">' + v.ignoredFilters.join(', ') + '</span>' : ''}`;
        resultsDiv.appendChild(el);
      });

      resultsDiv.scrollIntoView({ behavior: 'smooth' });
      copyToClipboard();
    }

    function copyToClipboard() {
      if (!lastSelection || lastSelection.length === 0) {
        document.getElementById('copiedMsg').innerText = "⚠️ Keine Auswahl zum Kopieren.";
        return;
      }

      let result = "🎲 ZENDOMIZER Auswahl:\n\n";

      lastSelection.forEach(vehicle => {
        result += `|| ${vehicle.category}:\n  ${vehicle.brand} ${vehicle.model} (${vehicle.year})\n\n`;
      });

      navigator.clipboard.writeText(result.trim()).then(() => {
        document.getElementById('copiedMsg').innerText = '✅ In Zwischenablage kopiert!';
        setTimeout(() => {
          document.getElementById('copiedMsg').innerText = '';
        }, 3000);
      });
    }


    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') drawRandomVehicles();
      if (e.key.toLowerCase() === 'r') repeatDraw();
      if (e.key.toLowerCase() === 'c') copyToClipboard();
    });

    window.onload = () => {
      bikeFilterMode = "no_bike";
      const bfb = document.getElementById("bikeFilterBtn");
      if (bfb) bfb.innerText = "Nur Autos";
      if (localStorage.getItem('darkmode') === 'true') {
        document.body.classList.add('dark');
      }

      fetch('cars/vehicles.json')
        .then(response => response.json())
        .then(data => {
          vehicles = data;
          initializeDropdowns();
          updatePreview();
        })
        .catch(err => {
          console.error("🚨 Fehler beim Laden von vehicles.json:", err);
          document.getElementById("preview").innerText = "⚠️ Fahrzeugdaten konnten nicht geladen werden.";
        });
    };
  </script>
</body>
</html>
